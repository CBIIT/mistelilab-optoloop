---
title: "DNA FISH spot distance & RNA FISH calculations at single-allele level"
author: "Martin Stortz/Gianluca Pegoraro"
date: today
date-format: long
format: 
  html:
      self-contained: true
      code-fold: true
      code-tools: true
      code-link: true
editor: source
---

###Load packages
```{r}
#| label: load-packages
#| include: false
#| warning: false

library(dplyr)
library(tidyverse)
library(fs)
library(data.table)
library(ggthemes)
library(SpatialTools)
library(knitr)
```

### User variables input and settings specification
```{r input-variables}
GLOB_C <- "*nuclei_information_well*" # Pattern for Single Cell data files
GLOB_S <- "*spots_locations_well*" # Pattern for Single Spot data files

XY_RES <- 0.108 #pixel size in um
```

### Metadata: Experimental conditions and plate layout
Provide experimental conditions and plate layout
```{r}
#| label: read-metadata

#Provide experimental conditions in desired order:
light_levs <- c("Ctrl","gRNA") 

plate_layout <- tibble(
  row = c(8L,9L),
  column = c(12L,12L),
  well_index = c("H12","I12"),
  light = c("Ctrl","gRNA") 
) %>%
  mutate(light = factor(light, levels = light_levs))
```

###Download data if needed
```{r}
#| label: download


```

###### Read cells and spots data
HITIPS output text files must be in the `data` directory and the file names must match the GLOB pattern.

### Read cells data
```{r}
#| label: read-cells

cell_tbl <- dir_info("data", 
                     recurse = T, 
                     glob = GLOB_C) %>%
  filter(size > "1K") %>%
  rowwise() %>%
  reframe(fread(path), file_name = as.character(path)) %>%
  mutate(well_index = paste0(LETTERS[row], column)) %>%
  select(file_name, column, row, well_index,
         field_index, time_point, cell_index,
         area, perimeter, solidity,
         x = `centroid-0`,
         y = `centroid-1`) %>%
  arrange(column, row, field_index,
          time_point, cell_index) %>%
  left_join(plate_layout, by = c("well_index", "row", "column"))

cell_tbl <- cell_tbl[!is.na(cell_tbl$light), ]  
```

Read and process the spot level data. Convert the x, y and z coordinates to microns (They were originally calculated in pixels) and filter spots that do not belong to any nucleus. These have a `cell_index` value of `0`.

### Read spots data
```{r}
#| label: read-spots

spots_tbl <- dir_info("data", 
                     recurse = T, 
                     glob = GLOB_S) %>%
  filter(size > "1K") %>%
  rowwise() %>%
  reframe(fread(path), file_name = as.character(path)) %>%
  mutate(well_index = paste0(LETTERS[row], column)) %>%
  select(file_name, column, row, 
         well_index, field_index, time_point, 
         cell_index,  channel, spot_index = V1,
         x = x_location, y = y_location, integrated_intensity) %>%
  #Convert xy distances from pixels to microns
  mutate(across(x:y, list(mic = ~ .x * XY_RES))) %>%
  #filter spots not in the nucleus
  filter(cell_index != 0) %>%
  arrange(column, row, field_index,
          time_point, cell_index, channel) %>%
  left_join(plate_layout, by = c("well_index", "row", "column"))

spots_tbl <- spots_tbl[!is.na(spots_tbl$light), ]  
```

### Filter cells by size and shape
```{r}
#| label: cell-filter

cell_filter_tbl <- cell_tbl %>%
  filter(area >= 50, solidity >= 0.92)
```

### Spot number per cell calculations
```{r}
#| label: calc-n-spots

cell_n_spots_tbl <- spots_tbl %>%
  group_by(column, row, well_index, light, field_index,
           time_point, cell_index, channel) %>%
  count() %>%
  pivot_wider(names_from = channel,
              names_prefix = "n_spots_channel_",
              values_from = n,
              values_fill = 0) %>%
  ungroup()
```

### Filter cells by spot number
```{r}
#| label: filter-spots

spot_filt_criterion <- quote(n_spots_channel_4 == 3 & n_spots_channel_2 == n_spots_channel_4) #set criterion for filtering

cell_n_spots_filt_tbl <- cell_n_spots_tbl %>%
  semi_join(cell_filter_tbl, by = c("row", "column", "well_index", "light", "field_index",
                             "time_point", "cell_index")) %>%
  filter(!!spot_filt_criterion)
```

### Filter out spots according to previous cell filtering by size, shape and spot number
```{r}
#| label: filter-spots-2

spot_filt_tbl <- spots_tbl %>% 
  semi_join(cell_n_spots_filt_tbl, 
            by = c("column", "row", "field_index", "light",
                   "time_point", "cell_index")) %>%
  as.data.table()
```

*2D Spot distance calculations*

###Calculate distances between all possible DNA spot pairs for each cell
```{r}
#| label: calc-spot-dist

gf_dist_2D <- spot_filt_tbl[channel %in% c(2,4), # Only far-Red and Green spots
                              reshape2::melt(SpatialTools::dist2(as.matrix(.SD[channel == 2,
                                                       list(x_mic,y_mic)]),
                                         as.matrix(.SD[channel == 4,
                                                       list(x_mic,y_mic)])),
                                   value.name = "gf_dist"),
                          by = list(row, 
                                    column,
                                    well_index,
                                    light,
                                    field_index, 
                                    time_point, 
                                    cell_index)]

setnames(gf_dist_2D, c("Var1","Var2"), c("g_index","f_index"))



# create g_index in spot_filt_tbl for channel 2 spots (per group)
key_cols <- c("row","column","well_index","light","field_index","time_point","cell_index")
spot_filt_tbl[
  channel == 2,
  g_index := seq_len(.N),
  by = key_cols
]
# merge ch5_* columns from channel 2 onto gf_dist_2D by group + g_index
gf_dist_2D <- merge(
  gf_dist_2D,
  spot_filt_tbl[channel == 2, c(key_cols, "g_index"), with = FALSE],
  by = c(key_cols, "g_index"),
  all.x = TRUE
)
```

###Calculate distances between all possible ch2DNA-RNA spot pairs for each cell
```{r}
#| label: calc-spot-dist2

gr_dist_2D <- spot_filt_tbl[channel %in% c(2,3), # Only Red and Green spots
                              reshape2::melt(SpatialTools::dist2(as.matrix(.SD[channel == 2,
                                                       list(x_mic,y_mic)]),
                                         as.matrix(.SD[channel == 3,
                                                       list(x_mic,y_mic)])),
                                   value.name = "gr_dist"),
                          by = list(row, 
                                    column,
                                    well_index,
                                    light,
                                    field_index, 
                                    time_point, 
                                    cell_index)]

setnames(gr_dist_2D, c("Var1","Var2"), c("g_index","r_index"))
```

*2D Spot minimum distance calculations*

###Find minimum DNA spot distance
Minimum distance is calculated based on channel 2 spots as reference
```{r}
#| label: proximity-green-farred

setkey(gf_dist_2D, row, column, well_index,
       field_index, time_point, cell_index, g_index)

gf_dist_min_2D <- gf_dist_2D[, .SD[which.min(gf_dist),], 
                        by = key(gf_dist_2D)] %>%
  left_join(select(cell_tbl, column:well_index, light, field_index:area),
            by = c("column", "row",
                   "well_index", "light", "field_index",
                   "time_point", "cell_index"))
```

###Find minimum ch2DNA-RNA spot distance
Minimum distance is calculated based on channel 2 spots as reference
```{r}
#| label: proximity-green-red

setkey(gr_dist_2D, row, column, well_index,
       field_index, time_point, cell_index, g_index)

gr_dist_min_2D <- gr_dist_2D[, .SD[which.min(gr_dist),], 
                        by = key(gr_dist_2D)] %>%
  left_join(select(cell_tbl, column:well_index, light, field_index:area),
            by = c("column", "row",
                   "well_index", "light", "field_index",
                   "time_point", "cell_index"))
```

### Merge minimum distances tables
Join ch2DNA-RNA and ch2DNA-ch4DNA distances tables based on the Ch2 spot index
```{r}
gfr_dist_min_2D <- gf_dist_min_2D %>%
  full_join(gr_dist_min_2D, by = c("row", "column", "field_index", 
                                    "cell_index", "time_point", 
                                    "g_index"))
```


### Classify alleles based on ch2DNA-RNA and ch2DNA-ch4DNA distances

Establish that:
-   ch2DNA spots with a matching RNA spot closer than 2.5 um as ACTIVE
-   ch2DNA spots with a matching ch4DNA spot closer than 0.27 um as CLOSE
```{r}
gfr_dist_min_2D <- gfr_dist_min_2D %>%
 mutate(rna_status = ifelse(gr_dist >= 2.5 | is.na(gr_dist),
                            "Inactive",
                            "Active"),
        dna_status = ifelse(gf_dist < 0.27,
                           "Close", "Far"))
```


### Summary of fraction of alleles per status
```{r summary fractions}

gfr_status_summary <- gfr_dist_min_2D %>%
  group_by(light.x, rna_status, dna_status) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  mutate(fraction = n / sum(n)) %>%  # fraction of closer of far alleles for each active/inactive for each condition
  ungroup()

write.csv(gfr_status_summary, "output/single_allele_summary.csv", row.names = FALSE)
```


## Session info
```{r}
#| label: session-info
#| results: markup

sessionInfo()
```
